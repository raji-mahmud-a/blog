<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Blog ‚Äî SPA</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind custom colors
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0fdf9',
              100: '#ccfbf1',
              500: '#10b981',
              700: '#047857'
            },
            accent: { 500: '#f59e0b' }
          }
        }
      }
    }
  </script>

  <style>
    /* simple SPA view transitions */
    .view { display: none; opacity: 0; transition: opacity .18s ease; }
    .view.active { display: block; opacity: 1; }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-white text-slate-800 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur sticky top-0 z-30 border-b">
    <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="#/home" class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary-500 flex items-center justify-center text-white font-semibold shadow">B</div>
        <div>
          <h1 class="text-lg font-semibold">My Blog</h1>
          <p class="text-xs text-slate-500 -mt-1">Thoughts, tutorials & updates</p>
        </div>
      </a>

      <nav class="flex items-center gap-3">
        <a href="#/home" class="text-slate-600 hover:text-primary-700">Home</a>
        <a href="#/new" class="px-3 py-1 rounded-md bg-primary-500 text-white text-sm shadow hover:bg-primary-700">Add Post</a>
      </nav>
    </div>
  </header>

  <!-- Main SPA container -->
  <main class="flex-1 w-full max-w-5xl mx-auto px-6 py-10">
    <!-- Home view -->
    <section id="view-home" class="view">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h2 class="text-3xl font-extrabold">Latest posts</h2>
          <p class="text-slate-500 mt-1">Published posts from the site.</p>
        </div>

        <div class="flex items-center gap-2">
          <input id="q" type="search" placeholder="Search posts..." class="px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500" />
        </div>
      </div>

      <div id="posts-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>

      <div id="home-empty" class="hidden text-center py-16 text-slate-500">No posts found.</div>

      <div id="home-loading" class="text-center py-12">
        <svg class="animate-spin h-8 w-8 mx-auto text-primary-500" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <p class="text-slate-500 mt-3">Loading posts...</p>
      </div>
    </section>

    <!-- Post detail view -->
    <section id="view-post" class="view">
      <button id="back-home" class="mb-5 text-primary-700 hover:underline">&larr; Back to posts</button>
      <article id="post-content" class="prose max-w-none"></article>
      <div id="post-loading" class="text-center py-12 hidden">
        <svg class="animate-spin h-8 w-8 mx-auto text-primary-500" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
      </div>
    </section>

    <!-- New post form view -->
    <section id="view-new" class="view">
      <h2 class="text-2xl font-bold mb-6">Create a New Post</h2>

      <form id="new-post-form" class="max-w-2xl bg-white border p-6 rounded-lg shadow space-y-4">
        <div>
          <label class="block mb-1 font-medium">Title</label>
          <input name="title" required minlength="5" maxlength="200" class="w-full border px-3 py-2 rounded-lg focus:ring-2 ring-primary-100 outline-none" />
        </div>

        <div>
          <label class="block mb-1 font-medium">Content</label>
          <textarea name="content" required minlength="50" maxlength="5000" rows="7" class="w-full border px-3 py-2 rounded-lg focus:ring-2 ring-primary-100 outline-none"></textarea>
        </div>

        <div>
          <label class="block mb-1 font-medium">Excerpt (optional, max 200)</label>
          <textarea name="excerpt" rows="2" maxlength="200" class="w-full border px-3 py-2 rounded-lg focus:ring-2 ring-primary-100 outline-none"></textarea>
        </div>

        <div>
          <label class="block mb-1 font-medium">Featured image</label>
          <input name="upload" type="file" accept="image/*" required class="w-full border rounded px-2 py-2" />
        </div>

        <div>
          <label class="block mb-1 font-medium">Status</label>
          <select name="status" class="w-full border px-3 py-2 rounded-lg">
            <option value="published">Publish now</option>
            <option value="draft">Save as draft</option>
          </select>
        </div>

        <div>
          <button type="submit" class="w-full py-2 bg-primary-500 hover:bg-primary-700 text-white rounded font-semibold shadow">Submit post</button>
        </div>

        <div id="form-result" class="text-center text-sm font-medium"></div>
      </form>
    </section>
  </main>

  <footer class="border-t bg-white">
    <div class="max-w-5xl mx-auto px-6 py-6 text-slate-500 text-sm text-center">
      ¬© <span id="year"></span> My Blog ‚Äî static SPA
    </div>
  </footer>

  <script>
    // Basic SPA router using hash routes
    const views = {
      home: document.getElementById('view-home'),
      post: document.getElementById('view-post'),
      new: document.getElementById('view-new')
    }
    const postsGrid = document.getElementById('posts-grid')
    const homeLoading = document.getElementById('home-loading')
    const homeEmpty = document.getElementById('home-empty')
    const qInput = document.getElementById('q')
    const postContent = document.getElementById('post-content')
    const postLoading = document.getElementById('post-loading')
    const backHomeBtn = document.getElementById('back-home')
    const form = document.getElementById('new-post-form')
    const formResult = document.getElementById('form-result')

    document.getElementById('year').textContent = new Date().getFullYear()

    function show(viewName) {
      Object.values(views).forEach(v => v.classList.remove('active'))
      views[viewName].classList.add('active')
    }

    function parseHash() {
      const hash = location.hash.replace(/^#/, '') || '/home'
      const segments = hash.split('/').filter(Boolean)
      return segments
    }

    const wait = function(time){
    	return new Promise((resolve, reject)=>{
    		setTimeout(()=>{
    			resolve()
    		}, time)
    	})
    }

    async function router() {
      const seg = parseHash()
      if (seg.length === 0 || seg[0] === 'home') {
        show('home')
        await wait(1000)
        await loadPosts()
      } else if (seg[0] === 'post' && seg[1]) {
        show('post')
        await loadSinglePost(decodeURIComponent(seg[1]))
      } else if (seg[0] === 'new') {
        show('new')
        resetForm()
      } else {
        // default to home
        location.hash = '#/home'
      }
    }

    window.addEventListener('hashchange', router)
    window.addEventListener('DOMContentLoaded', router)

    // Load posts
    let posts = []
    async function loadPosts() {
      postsGrid.innerHTML = ''
      homeEmpty.classList.add('hidden')
      homeLoading.style.display = ''
      try {
        const res = await fetch('/api/posts')
        const j = await res.json()
        homeLoading.style.display = 'none'
        posts = (j && Array.isArray(j.data)) ? j.data : []
        renderPosts(posts)
      } catch (err) {
        homeLoading.style.display = 'none'
        homeEmpty.textContent = 'Failed to load posts.'
        homeEmpty.classList.remove('hidden')
        console.error(err)
      }
    }

    function renderPosts(list) {
      postsGrid.innerHTML = ''
      if (!list.length) {
        homeEmpty.classList.remove('hidden')
        return
      }
      homeEmpty.classList.add('hidden')
      list.forEach(p => postsGrid.appendChild(buildCard(p)))
    }

    function buildCard(post) {
      const card = document.createElement('article')
      card.className = 'bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden flex flex-col border'
      card.innerHTML = `
        <div class="h-44 w-full overflow-hidden bg-slate-100">
          <img class="w-full h-full object-cover" src="${escape(post.featured_image || '/static/default.jpg')}" alt="${escape(post.title)}" />
        </div>
        <div class="p-4 flex-1 flex flex-col">
          <h3 class="text-lg font-semibold mb-1">${escape(post.title)}</h3>
          <p class="text-sm text-slate-600 mb-3 flex-1">${escape(post.excerpt || '')}</p>
          <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
            <div>${new Date(post.created_at).toLocaleDateString()} ‚Ä¢ üëÅÔ∏è ${post.view_count || 0}</div>
            <a class="inline-flex items-center gap-2 px-3 py-1 bg-primary-500 text-white rounded-md text-sm shadow" href="#/post/${encodeURIComponent(post.slug)}">Read</a>
          </div>
        </div>
      `
      return card
    }

    // Search
    qInput.addEventListener('input', (e) => {
      const q = (e.target.value || '').trim().toLowerCase()
      if (!q) return renderPosts(posts)
      const filtered = posts.filter(p => (p.title + ' ' + (p.excerpt || '')).toLowerCase().includes(q))
      renderPosts(filtered)
    })

    // Single post
    async function loadSinglePost(slug) {
      postContent.innerHTML = ''
      postLoading.classList.remove('hidden')
      try {
        const res = await fetch('/api/posts/' + encodeURIComponent(slug))
        const j = await res.json()
        postLoading.classList.add('hidden')
        if (!j || !j.success) {
          postContent.innerHTML = `<div class="py-12 text-center text-rose-600">${escape(j?.error || 'Post not found')}</div>`
          return
        }
        const data = Array.isArray(j.data) ? j.data[0] : j.data
        if (!data) {
          postContent.innerHTML = `<div class="py-12 text-center text-rose-600">Post not found.</div>`
          return
        }
        renderPost(data)
      } catch (err) {
        postLoading.classList.add('hidden')
        postContent.innerHTML = `<div class="py-12 text-center text-rose-600">Failed to load post.</div>`
        console.error(err)
      }
    }

    function renderPost(p) {
      postContent.innerHTML = `
        ${p.featured_image ? `<img src="${escape(p.featured_image)}" alt="${escape(p.title)}" class="w-full rounded-lg mb-6 max-h-80 object-cover">` : ''}
        <h1 class="text-3xl font-extrabold mb-2 w-full">${escape(p.title)}</h1>
        <div class="text-sm text-slate-500 mb-6 w-full">${new Date(p.created_at).toLocaleString()} ‚Ä¢ üëÅÔ∏è ${p.view_count || 0}</div>
        <div class="prose max-w-none text-slate-700 max-w-full">${formatContent(p.content)}</div>
      `
    }

    backHomeBtn.addEventListener('click', () => location.hash = '#/home')

    // New post form submission (global access, no auth)
    function resetForm() {
      form.reset()
      formResult.textContent = ''
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      formResult.textContent = ''
      const fd = new FormData(form)
      // status already selectable; ensure upload field name is "upload" (backend expects upload.single('upload'))
      try {
        formResult.innerHTML = '<span class="text-primary-600">Creating post...</span>'
        const res = await fetch('/api/posts', { method: 'POST', body: fd })
        const j = await res.json()
        if (res.ok && j.success) {
          formResult.innerHTML = '<span class="text-emerald-700">Post created successfully. Redirecting...</span>'
          setTimeout(() => location.hash = '#/home', 1000)
        } else {
          formResult.innerHTML = `<span class="text-rose-600">${escape(j?.error || 'Failed to create post')}</span>`
          // If Zod error returned as array, show joined messages
          if (Array.isArray(j?.error)) {
            formResult.innerHTML = `<div class="text-rose-600">${j.error.join(' | ')}</div>`
          }
        }
      } catch (err) {
        formResult.innerHTML = '<span class="text-rose-600">Network error while creating post.</span>'
        console.error(err)
      }
    })

    // Helpers
    function escape(s) {
      if (s === null || s === undefined) return ''
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;')
    }

    function formatContent(c) {
      return (c || '').split(/\n+/).map(line => `<p class="max-w-full p-4">${escape(line)}</p>`).join('')
    }
  </script>
</body>
</html>
